import os, re
import glob
import shutil
import pandas as pd

##############################
# CONFIG
# can be overwritten by using --configfile <path to config> when calling snakemake
# configfile:"config/config.yaml"

include:
    "rules/init.smk"


rule assembly:
    input:
        os.path.join(RESULTS_DIR, "rawReads/concatenated_reads.fastq.gz"),
        os.path.join(RESULTS_DIR, "filteredReads/filtered_reads.fastq"),
        expand(os.path.join(RESULTS_DIR, "assemblies/flye.fasta")),
        expand(os.path.join(RESULTS_DIR, "assemblies/raven.fasta"),
        os.path.join(RESULTS_DIR, "stats/stats_assemblies.txt")
    # output:
    #     touch("status/preprocessing.done")


rule concatenate_reads:
	input:
		expand(os.path.join(READS_DIR, "{reads}.fastq.gz"), reads = READS)
	output:
		os.path.join(RESULTS_DIR, "rawReads/concatenated_reads.fastq.gz")
	shell:
		"cat {input} > {output}"

rule filter:
    input:
        os.path.join(RESULTS_DIR, "rawReads/concatenated_reads.fastq.gz")
    output:
        os.path.join(RESULTS_DIR, "filteredReads/filtered_reads.fastq")
    conda:
        os.path.join(ENV_DIR, "filtlong.yaml")
    params:
        reads_size = config["reads_size"]
    log:
        out=os.path.join(RESULTS_DIR, "logs/filter.out.log"),
        err=os.path.join(RESULTS_DIR, "logs/filter.err.log")
    shell:
        "(date && filtlong --min_length {params.reads_size} --keep_percent 90 {input} > {output} && date) 2> {log.err} > {log.out}"


rule flye:
    input:
        rules.filter.output
    output:
        folder = temp(directory(os.path.join(RESULTS_DIR, "flye/sample"))),
        fasta = os.path.join(RESULTS_DIR, "assemblies/flye_pre.fasta")
    conda:
        os.path.join(ENV_DIR, "flye.yaml")
    resources:
        time = "05:00:00"
    log:
        out=os.path.join(RESULTS_DIR, "logs/flye.out.log"),
        err=os.path.join(RESULTS_DIR, "logs/flye.err.log")
    threads: 16
    shell:
        """
        (date && flye --nano-raw {input} --out-dir {output.folder} --threads {threads} && 
        cp {output.folder}/assembly.fasta {output.fasta} && 
        date) 2> {log.err} > {log.out}
        """

rule raven:
    input:
        rules.filter.output
    output:
        fasta=os.path.join(RESULTS_DIR, "assemblies/raven_pre.fasta")
    log:
        out=os.path.join(RESULTS_DIR, "logs/raven.out.log"),
        err=os.path.join(RESULTS_DIR, "logs/raven.err.log")
    resources:
        time = "03:00:00"
    conda:
        os.path.join(ENV_DIR, "raven.yaml")
    threads: 8
    shell:
        "(date && raven --threads 8 --disable-checkpoints {input} > {output.fasta} && date) 2> {log.err} > {log.out}"


rule getStats:
    input:
        rules.raven.output.fasta,
        rules.flye.output.fasta
    output:
        os.path.join(RESULTS_DIR, "stats/stats_assemblies.txt")
    conda:
        os.path.join(ENV_DIR, "seqkit.yaml")
    threads: 1
    shell:
        "seqkit stats -T -a {input.raven} {input.flye} > {output}"


